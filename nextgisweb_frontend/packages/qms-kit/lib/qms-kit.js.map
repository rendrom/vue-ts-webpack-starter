{"version":3,"file":"qms-kit.js","sources":["../src/QmsKit.ts"],"sourcesContent":["import { StarterKit } from '@nextgis/webmap';\n\nexport interface QmsOptions {\n  url: string;\n}\n\ninterface GeoserviceInList {\n  id: number;\n  guid: string;\n  name: string;\n  desc: string;\n  type: string;\n  epsg: number;\n}\n\ninterface Geoservice {\n  id: number;\n  guid: string;\n  name: string;\n  desc: string;\n  type: string;\n  epsg: number;\n  license_name: string;\n  license_url: string;\n  copyright_text: string;\n  copyright_url: string;\n  terms_of_use_url: string;\n  url: string;\n  z_min: any;\n  z_max: any;\n  y_origin_top: boolean;\n  icon: number;\n}\n\nexport class QmsKit implements StarterKit {\n\n  options: QmsOptions = {\n    url: 'https://qms.nextgis.com',\n  };\n\n  url: string;\n  map;\n\n  constructor(options?: QmsOptions) {\n    this.options = { ...this.options, ...options };\n    this.url = this.options.url;\n\n  }\n\n  getLayerAdapters() {\n    return Promise.resolve([{\n      name: 'QMS',\n      createAdapter: (webmap) => Promise.resolve(this._createAdapter(webmap)),\n    }]);\n\n  }\n\n  async getQmsServices() {\n    return loadJSON<GeoserviceInList[]>(this.url + '/api/v1/geoservices/');\n  }\n\n  private _createAdapter(map) {\n    const url = this.url;\n    this.map = map;\n    const alias = {\n      tms: 'TILE',\n    };\n    const adapter = function(m, options) {\n      this.map = m;\n      this.name = options.id;\n    };\n\n    adapter.prototype.addLayer = function(options) {\n      return loadJSON<Geoservice>(url + '/api/v1/geoservices/' + options.qmsid).then((service) => {\n        if (service) {\n          const type = alias[service.type];\n          const webMapAdapter = map.layerAdapters[type];\n          if (webMapAdapter) {\n            if (type === 'TILE') {\n              options.url = service.url;\n              return webMapAdapter.prototype.addLayer.call(this, options);\n            }\n          }\n        }\n      });\n    };\n    return adapter;\n  }\n}\n\nfunction loadJSON<T = any>(url): Promise<T> {\n  return new Promise<T>((resolve, reject) => {\n    const xmlHttp = new XMLHttpRequest();\n    xmlHttp.onreadystatechange = () => {\n      if (xmlHttp.readyState === 4 && xmlHttp.status === 200) {\n        if (xmlHttp.responseText) {\n          try {\n            resolve(JSON.parse(xmlHttp.responseText));\n          } catch (er) {\n            reject(er);\n          }\n        }\n      }\n    };\n    xmlHttp.open('GET', fixUrlStr(url), true); // true for asynchronous\n    xmlHttp.send(null);\n  });\n}\n\nfunction fixUrlStr(url: string) {\n  // remove double slash\n  return url.replace(/([^:]\\/)\\/+/g, '$1');\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;QA2CE,gBAAY,OAAoB;YAPhC,YAAO,GAAe;gBACpB,GAAG,EAAE,yBAAyB;aAC/B,CAAC;YAMA,IAAI,CAAC,OAAO,gBAAQ,IAAI,CAAC,OAAO,EAAK,OAAO,CAAE,CAAC;YAC/C,IAAI,CAAC,GAAG,GAAG,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC;SAE7B;QAED,iCAAgB,GAAhB;YAAA,iBAMC;YALC,OAAO,OAAO,CAAC,OAAO,CAAC,CAAC;oBACtB,IAAI,EAAE,KAAK;oBACX,aAAa,EAAE,UAAC,MAAM,IAAK,OAAA,OAAO,CAAC,OAAO,CAAC,KAAI,CAAC,cAAc,CAAC,MAAM,CAAC,CAAC,GAAA;iBACxE,CAAC,CAAC,CAAC;SAEL;QAEK,+BAAc,GAApB;;;oBACE,WAAO,QAAQ,CAAqB,IAAI,CAAC,GAAG,GAAG,sBAAsB,CAAC,EAAC;;;SACxE;QAEO,+BAAc,GAAtB,UAAuB,GAAG;YACxB,IAAM,GAAG,GAAG,IAAI,CAAC,GAAG,CAAC;YACrB,IAAI,CAAC,GAAG,GAAG,GAAG,CAAC;YACf,IAAM,KAAK,GAAG;gBACZ,GAAG,EAAE,MAAM;aACZ,CAAC;YACF,IAAM,OAAO,GAAG,UAAS,CAAC,EAAE,OAAO;gBACjC,IAAI,CAAC,GAAG,GAAG,CAAC,CAAC;gBACb,IAAI,CAAC,IAAI,GAAG,OAAO,CAAC,EAAE,CAAC;aACxB,CAAC;YAEF,OAAO,CAAC,SAAS,CAAC,QAAQ,GAAG,UAAS,OAAO;gBAAhB,iBAa5B;gBAZC,OAAO,QAAQ,CAAa,GAAG,GAAG,sBAAsB,GAAG,OAAO,CAAC,KAAK,CAAC,CAAC,IAAI,CAAC,UAAC,OAAO;oBACrF,IAAI,OAAO,EAAE;wBACX,IAAM,IAAI,GAAG,KAAK,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;wBACjC,IAAM,aAAa,GAAG,GAAG,CAAC,aAAa,CAAC,IAAI,CAAC,CAAC;wBAC9C,IAAI,aAAa,EAAE;4BACjB,IAAI,IAAI,KAAK,MAAM,EAAE;gCACnB,OAAO,CAAC,GAAG,GAAG,OAAO,CAAC,GAAG,CAAC;gCAC1B,OAAO,aAAa,CAAC,SAAS,CAAC,QAAQ,CAAC,IAAI,CAAC,KAAI,EAAE,OAAO,CAAC,CAAC;6BAC7D;yBACF;qBACF;iBACF,CAAC,CAAC;aACJ,CAAC;YACF,OAAO,OAAO,CAAC;SAChB;QACH,aAAC;IAAD,CAAC,IAAA;IAED,SAAS,QAAQ,CAAU,GAAG;QAC5B,OAAO,IAAI,OAAO,CAAI,UAAC,OAAO,EAAE,MAAM;YACpC,IAAM,OAAO,GAAG,IAAI,cAAc,EAAE,CAAC;YACrC,OAAO,CAAC,kBAAkB,GAAG;gBAC3B,IAAI,OAAO,CAAC,UAAU,KAAK,CAAC,IAAI,OAAO,CAAC,MAAM,KAAK,GAAG,EAAE;oBACtD,IAAI,OAAO,CAAC,YAAY,EAAE;wBACxB,IAAI;4BACF,OAAO,CAAC,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,YAAY,CAAC,CAAC,CAAC;yBAC3C;wBAAC,OAAO,EAAE,EAAE;4BACX,MAAM,CAAC,EAAE,CAAC,CAAC;yBACZ;qBACF;iBACF;aACF,CAAC;YACF,OAAO,CAAC,IAAI,CAAC,KAAK,EAAE,SAAS,CAAC,GAAG,CAAC,EAAE,IAAI,CAAC,CAAC;YAC1C,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;SACpB,CAAC,CAAC;IACL,CAAC;IAED,SAAS,SAAS,CAAC,GAAW;QAE5B,OAAO,GAAG,CAAC,OAAO,CAAC,cAAc,EAAE,IAAI,CAAC,CAAC;IAC3C,CAAC;;;;;;;;;;;;"}